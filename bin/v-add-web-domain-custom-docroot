#!/bin/bash
# info: Add a custom docroot to a domain allow ssl on a alias when domain is not the same
# options: USER DOMAIN1 DOMAIN2
#
# The call is to modify the docroot of DOMAIN1 to DOMAIN2 (Public and Private) 
# so it can be used as an multisite setup for an CMS add allow his own SSL Certificate


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
domain2=$3

# Includes
source $HESTIA/func/main.sh
source $HESTIA/func/domain.sh
source $HESTIA/conf/hestia.conf

# Additional argument formatting
format_domain


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '3' "$#" 'USER DOMAIN DOMAIN2'
is_format_valid 'user' 'domain' 'domain2'

is_system_enabled "$WEB_SYSTEM" 'WEB_SYSTEM'
is_type_valid "$STATS_SYSTEM" "$type"
is_object_valid 'user' 'USER' "$user" "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_object_valid 'web' 'DOMAIN' "$domain"
is_object_valid 'web' 'DOMAIN' "$domain2"
is_object_unsuspended 'web' 'DOMAIN' "$domain"
is_object_unsuspended 'web' 'DOMAIN' "$domain2"
is_object_value_empty 'web' 'DOMAIN' "$domain" '$docroot'

# Perform verification if read-only mode is enabled
check_hestia_demo_mode


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#


if [ -z "$CUSTOM_DOCROOT" ]; then
    CUSTOM_DOCROOT="$domain2"
fi
prepare_web_domain_values

# Rebuilding vhost
del_web_config "$WEB_SYSTEM" "$TPL.tpl"
add_web_config "$WEB_SYSTEM" "$TPL.tpl"
if [ "$SSL" = 'yes' ]; then
    del_web_config "$WEB_SYSTEM" "$TPL.stpl"
    add_web_config "$WEB_SYSTEM" "$TPL.stpl"
fi

# Rebuilding proxy configuration
if [ ! -z "$PROXY_SYSTEM" ] && [ ! -z "$PROXY" ]; then
    del_web_config "$PROXY_SYSTEM" "$PROXY.tpl"
    add_web_config "$PROXY_SYSTEM" "$PROXY.tpl"
    if [ "$SSL" = 'yes' ]; then
        del_web_config "$PROXY_SYSTEM" "$PROXY.stpl"
        add_web_config "$PROXY_SYSTEM" "$PROXY.stpl"
    fi
fi



#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#


if [ is_object_value_exist 'web' 'DOMAIN' "$domain" 'CUSTOM_DOCROOT' ]; then 
    update_object_value 'web' 'DOMAIN' "$domain" 'CUSTOM_DOCROOT' "DOMAIN2"
else
    add_object_value 'web' 'DOMAIN' "$domain" 'CUSTOM_DOCROOT' "DOMAIN2"
fi

# Logging
log_history "docroot changed $domain to $domain2"
log_event "$OK" "$ARGUMENTS"

# Build stats
exec $BIN/v-update-web-domain-stat $user $domain

exit
